<?php/** * Created by PhpStorm. * User: Lyunp * Date: 2019/12/24 * Time: 15:06 */namespace app\mall\controller;use app\common\controller\Mall;use app\common\model\AreaMallBillOrder;use app\common\model\AreaMallBuilding;use app\common\model\Buyer;/** * 工地模型控制层 * Class BuildingMall * @package app\mall\controller */class BuildingMall extends Mall{    /**     * 查询     * @return array|mixed|\think\response\Json     * @throws \think\db\exception\DataNotFoundException     * @throws \think\db\exception\ModelNotFoundException     * @throws \think\exception\DbException     */    public function index()    {        //获取权限的筛选条件        $userWhere = $this->getMyUserWhere();        //这里只有区域管理员可以设置，这里先注释掉        $mallId = isset($userWhere[self::PERMISSION_MALL]) ? $userWhere[self::PERMISSION_MALL] : 0;        $model = new AreaMallBuilding();        if($this->request->isAjax())        {            $params = $this->request->param();            if($params)            {                $where = [];                $page = isset($params['page']) ? $params['page'] : 1;                $limit = isset($params['limit']) ? $params['limit'] : 10;                $where['mall_id'] = $mallId;                list($where,$page,$limit) = [$where,$page,$limit];                $list = $model                    ->where($where)                    ->page($page,$limit)                    ->order('created_at','desc')                    ->select();                $total = $model                    ->where($where)                    ->count();                foreach ($list as $key=>$item) {                    $list[$key]['buyer_name'] = Buyer::get(['buyer_id'=>$item['buyer_id']])->buyer_name;                }                $result = array("code"=>0,"count" => $total, "data" => $list);                return json($result);            }            return [];        }        return $this->fetch();    }    /**     * 详情     * @return mixed     */    public function info()    {        $this->view->engine->layout(false);        //获取权限的筛选条件        $userWhere = $this->getMyUserWhere();        //这里只有区域管理员可以设置，这里先注释掉        $mallId = isset($userWhere[self::PERMISSION_MALL]) ? $userWhere[self::PERMISSION_MALL] : 0;        $id     = $this->request->param('id');        //查询工地信息        $info = AreaMallBuilding::get($id);        if(!$info) $info = [];        $buyer = Buyer::get(['buyer_id'=>$info['buyer_id']]);        $this->assign(compact('info','buyer'));        return $this->fetch();    }    /**     * 更新状态     * @return array     */    public function state()    {        if($this->request->isGet())        {            $params = $this->request->param();            if($params)            {                $id     = isset($params['id']) ? $params['id'] : -1;                $info   = AreaMallBuilding::get($id);                if(!$info) return ['status'=>false,'msg'=>'数据异常'];                $state  = isset($params['state']) ? $params['state'] : 0;                switch ($state){                    case '10':                        AreaMallBuilding::update(['step_state'=>10,'status'=>1],['id'=>$info['id']]);                        return ['status'=>true,'msg'=>'审核成功'];                        break;                    case '40':                        AreaMallBuilding::update(['status'=>4],['id'=>$info['id']]);                        return ['status'=>true,'msg'=>'审核成功'];                        break;                    default:                        return ['status'=>false,'msg'=>'审核失败'];                        break;                }            }            return ['status'=>false,'msg'=>'参数错误'];        }        return ['status'=>false,'msg'=>'异常请求'];    }}